/* -*-c++-*- */
/* osgEarth - Dynamic map generation toolkit for OpenSceneGraph
 * Copyright 2008-2016 Pelican Mapping
 * http://osgearth.org
 *
 * osgEarth is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>
 */
#ifndef OSGEARTH_BUILDINGS_ELEVATION_H
#define OSGEARTH_BUILDINGS_ELEVATION_H

#include "Common"
#include "Footprint"
#include "Roof"
#include <osg/Vec3d>
#include <osg/Texture>
#include <osgEarthSymbology/Skins>
#include <vector>
#include <list>

namespace osgEarth { namespace Buildings
{
    using namespace osgEarth::Symbology;

    /**
     * A vertical section of a building.
     */
    class OSGEARTHBUILDINGS_EXPORT Elevation : public osg::Referenced
    {
    public:
        /** Constructor */
        Elevation();

        /**
         * Sets the height (in meters) of this elevation.
         */
        void setHeight(float height) { _height = height; }
        float getHeight() const      { return _height; }

        /**
         * Number of floors in this elevation. This value is calculated.
         */
        void setNumFloors(unsigned num) { _numFloors = num; }
        unsigned getNumFloors() const { return _numFloors; }

        /**
         * The roof.
         */
        void setRoof(Roof* roof) { _roof = roof; }
        Roof* getRoof() const    { return _roof.get(); }

        /**
         * The skin (texture and properties) for the elevation walls.
         */
        void setSkinResource(SkinResource* res) { _skinResource = res; }
        SkinResource* getSkinResource() const   { return _skinResource; }

        /**
         * Skin to use to texture this elevation. (optional)
         */
        void setSkinSymbol(SkinSymbol* skin) { _skin = skin; }
        SkinSymbol* getSkinSymbol() const    { return _skin.get(); }

        /**
         * Builds an internal structure for this elevation. If this returns
         * true, you can then call getWalls() to access the structure.
         */
        bool build(const Footprint* footprint);


    public: // structural data model elements

        // A Corner is one vertex in the footprint extruded from bottom to top
        struct Corner
        {
            osg::Vec3d lower, upper;
            osg::Vec2f roofUV;
            float      offsetX;
            bool       isFromSource;
            float      cosAngle;
            float      height;            
        };
        typedef std::list<Corner> Corners; // use a list to prevent iterator invalidation

        // A Face joins two Corners.
        struct Face
        {
            Corner left;
            Corner right;
            float widthM;
        };
        typedef std::vector<Face> Faces;

        // A wall is a closed collection of Faces.
        struct Wall
        {
            Faces  faces;
            float texHeightAdjustedM;

            unsigned getNumPoints() const {
                return faces.size() * 6;
            }
        };
        typedef std::vector<Wall> Walls;

        /**
         * The structure of the elevation that was created by buildStructure.
         */
        const Walls& getWalls() const { return _walls; }

    protected:
        float _height;
        unsigned _numFloors;
        osg::ref_ptr<SkinResource> _skinResource;
        osg::ref_ptr<SkinSymbol> _skin;
        Walls _walls;
        osg::ref_ptr<Roof> _roof;

    protected:
        virtual ~Elevation() { }

        /**
         * Determines the apparent rotation of a building.
         */
        float getRotation(const Footprint*) const;
    };

    typedef std::vector< osg::ref_ptr<Elevation> > ElevationVector;

} }

#endif // OSGEARTH_BUILDINGS_ELEVATION_H
